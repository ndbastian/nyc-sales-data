---
title: "Results"
output: pdf_document
bibliography: bib/bibliography.bib
---

```{r message=FALSE, warning=FALSE, include=FALSE}
suppressPackageStartupMessages({library(tidyverse)})
```


## Sale Price Model

Using Root Mean Squared Error (RMSE) as an evaluation metric of predictive power, we find that the Spatial Lag modeling features consistently outperform the Zip Code features, while the Base modeling data tends to outperform both, as shown in the following Table (lower RMSE is better):

```{r Sale Price Evaluations, fig.cap= "Sale Price Model Evaluations", echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
pander::pander(read_rds("tables and figures/sales model evaluations.rds") %>% rename("spatial lag" = radii)
               , caption = "Sale Price Model RMSE For Validation and Test Hold-out Data"
               , split.table = Inf
               , style = "rmarkdown"
               , justify = "left")
```

Interestingly, both the Spatial Lag modeling data and the Zip Code modeling data are extensions of the Base data, yet the Base data tends to generalize to the hold-out data sets better. From this, we make two observations:

1) Building characteristic data, which largely comprises the Base modeling data, are the most important for predicting building sale price per foot
2) The Zip Code and Spatial Lag models are suffering from over-fitting of the data, which is limiting their ability to generalize to the hold-out samples. 

It is possible that the over-fitting issue could be corrected through hyper-parameter tuning of the algorithms, as well as implementing stricter variable selection. Despite this, we can still safely conclude that the Spatial Lag features are superior to the Zip Code features in terms of predictive power. 

Taking a closer look at the data, we find that the models have varying performance across Building Types and Boroughs. Figure \ref{fig:RMSE by boro and build type} shows RMSE by Model, faceted by Borough across the y-axis and Building Type across the x-axis (See Table 2 for a description of building type codes). 


```{r RMSE by boro and build type, fig.cap="RMSE By Borough and Building Type", out.width = '100%', echo=FALSE, message=FALSE, warning=FALSE}
knitr::include_graphics("Sections/tables and figures/RMSE by boro and build type.jpeg")
```


We make the following observations from Figure \ref{fig:RMSE by boro and build type}:

- The Spatial Lag modeling data outperforms both Base and Zip Code in 6 cases, notably for Type A buildings (One Family Dwellings) and Type L buildings (Lofts) in Manhattan as well as Type O Buildings (Office) in Queens
- It is generally harder to predict sale prices in Manhattan than other Boroughs
- The "residential" building Types A (One Family Dwellings), B (Two Family Dwellings), C (Walk Up Apartments) and D (Elevator Apartments) have generally lower RMSE scores compared to the non-residential types

If we rank the models by performance for each Borough, Building Type combination, we find that the Spatial Lag models outperform the Zip Code models in 72% of cases. Table 9 shows the average ranking by model type as well as the percent distribution by model type across rankings.

```{r Sale Price Model Rank Distributions, fig.cap= "Sale Price Model Evaluations", echo=FALSE, message=FALSE, warning=FALSE}

pander::pander(
  left_join(
    read.csv("tables and figures/model rank perc distribution table.csv", check.names = FALSE)
    ,read_rds("tables and figures/average sales model rank rmse.rds")
    , by = c("Model Rank" = "Model")
    ,sort = F
  )
  , caption = "Sale Price Model Rankings, RMSE by Borough and Building Type"
  , split.table = Inf
  , style = "rmarkdown"
  , justify = "left")
```



## Probability of Sale Model

Similar to the results found in the Sale Price models, using Area Under the ROC Curve (AUC) as an evaluation metric, we find the Spatial Lag model performs better on the hold-out validation data compared to the Zip Code modeling data, as shown in Table 10. The Base Modeling data continues to outperform the Spatial Lag and Zip Code modeling data overall, however, when broken down by Borough and Building Type, some interesting patterns emerge. 

```{r Prob Model AUC, fig.cap= "Sale Price Model Evaluations", echo=FALSE, message=FALSE, warning=FALSE}
pander::pander(read.csv("tables and figures/Prob Models AUC evaluations.csv", check.names = FALSE)
                , caption = "Probability of Sale Models AUC"
                , split.table = Inf
                , style = "rmarkdown"
                , justify = "left")

```


Looking at the predictions by the models made on the 2017 validation hold-out data, we see the Spatial Lag model performs best of any model for three out of five Boroughs: Manhattan, Bronx and Staten Island (Table 11).

```{r Prob Model AUC by Boro, fig.cap= "Sale Price Model Evaluations", echo=FALSE, message=FALSE, warning=FALSE}
pander::pander(read.csv("tables and figures/AUC by borogh.csv", check.names = FALSE)
                , caption = "Probability of Sale Models AUC by Borough"
                , split.table = Inf
                , style = "rmarkdown"
                , justify = "left")
```

Figure \ref{fig:AUC by boro and build type} shows a breakdown of model AUC faceted along the x-axis by Building Type and along the y-axis by Borough. The coloring indicated by how much a model's AUC diverges from the cell average. 


```{r AUC by boro and build type, fig.cap="AUC By Borough and Building Type", out.width = '100%', echo=FALSE}
knitr::include_graphics("Sections/tables and figures/AUC by boro and build type.jpeg")
```

We make the following observations about Figure \ref{fig:AUC by boro and build type}:

- The Spatial Lag model outperforms all other models for Elevator Buildings (Type D), particularly in the Bronx
- The Probability of Sale model tends to perform poorly in Manhattan vs. other Boroughs
- However, the Spatial Lag model performs well in Manhattan for the residential building types (A, B, C and D)

If we rank model the probability models' performance for each Borough and Building Type, we see that the Spatial Lag models consistently outperform the Zip Code models, as shown in Table 12.

```{r Prob Model AUC Average Rank, fig.cap= "Sale Price Model Evaluations", echo=FALSE, message=FALSE, warning=FALSE}
pander::pander(
  
  left_join(read.csv("tables and figures/auc model rank perc distribution table.csv", check.names = FALSE)
            , read.csv("tables and figures/average prob model rank auc.csv", check.names = FALSE)
            , by = c("Model Rank" = "Model"))
                , caption = "Distribution and Average Model Rank for Probability of Sale by AUC across Borough and Building Types"
                , split.table = Inf
                , style = "rmarkdown"
                , justify = "left")

```





