---
title: "Results"
output: pdf_document
bibliography: bib/bibliography.bib
---

```{r message=FALSE, warning=FALSE, include=FALSE}
suppressPackageStartupMessages({library(tidyverse)})
```

## Sale Price Model

The Root Mean Squared Error (RMSE) of all models predicting Sale Price is analyzed at the data set, Borough and Building Type level. Table \ref{tab:SalePriceEval} shows the average ranking by model type as well as the distribution of models that ranked first, second and third for each respective Borough/Building Type combination using RMSE as a ranking metric. If we rank the models by performance for each Borough, Building Type combination, we find that the Spatial Lag models outperform the Zip Code models in 72% of cases with an average model-rank of 2.11 and 2.5, respectively. The Base modeling data set tends to outperform both enriched datasets, suggesting an issue with model over-fit in some areas. Despite this, the Spatial Lag feature data sets outperform all other models for certain building types, notably for Type A buildings (One Family Dwellings) and Type L buildings (Lofts) in Manhattan as well as Type O Buildings (Office) in Queens as shown in \ref{fig:RMSE by boro and build type}. 


```{r Sale Price Evaluations, fig.cap= "Sale Price Model Evaluations", echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

read_rds("tables and figures/sales model evaluations.rds") %>% rename("spatial lag" = radii) %>% 
  my_kable(caption = "Sale Price Model RMSE For Validation and Test Hold-out Data"
           , label = "SalePriceEval"
           , latex_options = "basic")
```


Figure \ref{fig:RMSE by boro and build type} shows RMSE by Model, faceted by Borough across the y-axis and Building Type across the x-axis (See Table 2 for a description of building type codes). We make the following observations from Figure \ref{fig:RMSE by boro and build type}:

- The Spatial Lag modeling data outperforms both Base and Zip Code in 6 cases, notably for Type A buildings (One Family Dwellings) and Type L buildings (Lofts) in Manhattan as well as Type O Buildings (Office) in Queens
- It is generally harder to predict sale prices in Manhattan compared to other Boroughs
- The "residential" building Types A (One Family Dwellings), B (Two Family Dwellings), C (Walk Up Apartments) and D (Elevator Apartments) have generally lower RMSE scores compared to the non-residential types


```{r RMSE by boro and build type, fig.cap="RMSE By Borough and Building Type", out.width = '100%', echo=FALSE, message=FALSE, warning=FALSE}
knitr::include_graphics("Sections/tables and figures/RMSE by boro and build type.jpeg")
```


```{r Sale Price Model Rank Distributions, fig.cap= "Sale Price Model Evaluations", echo=FALSE, message=FALSE, warning=FALSE}

read.csv("tables and figures/model rank perc distribution table.csv", check.names = FALSE) %>% 
  left_join(read_rds("tables and figures/average sales model rank rmse.rds")
    , by = c("Model Rank" = "Model")
    , sort = F) %>% 
  my_kable(caption = "Sale Price Model Rankings, RMSE by Borough and Building Type"
           , label = "SalePriceModelRank"
           , latex_options = "basic")
  
  
```



## Probability of Sale Model

Similar to the results found in the Sale Price models, using Area Under the ROC Curve (AUC) as an evaluation metric, we find the Spatial Lag model performs better on the hold-out validation data compared to the Zip Code modeling data, as shown in Table  \ref{tab:ProbSaleModelAUC}. The Base Modeling data continues to outperform the Spatial Lag and Zip Code modeling data overall, however, when broken down by Borough and Building Type, some interesting patterns emerge. 

```{r Prob Model AUC, fig.cap= "Sale Price Model Evaluations", echo=FALSE, message=FALSE, warning=FALSE}
read.csv("tables and figures/Prob Models AUC evaluations.csv", check.names = FALSE) %>% 
  my_kable(caption = "Probability of Sale Model AUC"
           , label = "ProbSaleModelAUC"
           , latex_options = "basic")
```


Looking at the predictions by the models made on the 2017 validation hold-out data, we see the Spatial Lag model performs best of any model for three out of five Boroughs: Manhattan, Bronx and Staten Island (see: Table \ref{tab:ProbSaleModelAUCbyBoro}).

```{r Prob Model AUC by Boro, fig.cap= "Sale Price Model Evaluations", echo=FALSE, message=FALSE, warning=FALSE}
read.csv("tables and figures/AUC by borogh.csv", check.names = FALSE) %>% 
my_kable(caption = "Probability of Sale Models AUC by Borough"
           , label = "ProbSaleModelAUCbyBoro"
         , latex_options = "basic")
```

Figure \ref{fig:AUC by boro and build type} shows a breakdown of model AUC faceted along the x-axis by Building Type and along the y-axis by Borough. The coloring indicated by how much a model's AUC diverges from the cell average. 


```{r AUC by boro and build type, echo=FALSE, fig.cap="AUC By Borough and Building Type", message=FALSE, warning=FALSE, out.width='100%', paged.print=FALSE}
knitr::include_graphics("Sections/tables and figures/AUC by boro and build type.jpeg")
```

We make the following observations about Figure \ref{fig:AUC by boro and build type}:

- The Spatial Lag model outperforms all other models for Elevator Buildings (Type D), particularly in the Bronx
- The Probability of Sale model tends to perform poorly in Manhattan vs. other Boroughs
- However, the Spatial Lag model performs well in Manhattan for the residential building types (A, B, C and D)

If we rank model the probability models' performance for each Borough and Building Type, we see that the Spatial Lag models consistently outperform the Zip Code models, as shown in  Table \ref{tab:ProbModelAUCRank}

```{r Prob Model AUC Average Rank, fig.cap= "Sale Price Model Evaluations", echo=FALSE, message=FALSE, warning=FALSE}

  read.csv("tables and figures/auc model rank perc distribution table.csv", check.names = FALSE) %>%
  left_join(read.csv("tables and figures/average prob model rank auc.csv", check.names = FALSE)
            , by = c("Model Rank" = "Model")) %>% 
    my_kable(caption = "Distribution and Average Model Rank for Probability of Sale by AUC across Borough and Building Types"
             , latex_options = "basic"
             , label = "ProbModelAUCRank")
               
```



```{r Model AUC Comparrison, echo=FALSE, fig.cap="Model AUCs", message=FALSE, warning=FALSE, out.width='100%', paged.print=FALSE}

knitr::include_graphics("Sections/tables and figures/compare_model_roc_curves.png")

```
















